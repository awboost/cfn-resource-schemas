{
  "$hash": "53199919936c2046a83a4ab58e33711b62af28b9",
  "$id": "aws-imagebuilder-image.json",
  "additionalProperties": false,
  "conditionalCreateOnlyProperties": [
    "/properties/ImagePipelineExecutionSettings"
  ],
  "createOnlyProperties": [
    "/properties/ImageRecipeArn",
    "/properties/ContainerRecipeArn",
    "/properties/InfrastructureConfigurationArn",
    "/properties/Workflows",
    "/properties/DistributionConfigurationArn",
    "/properties/ImageTestsConfiguration",
    "/properties/ImageScanningConfiguration",
    "/properties/EnhancedImageMetadataEnabled"
  ],
  "definitions": {
    "DeletionSettings": {
      "additionalProperties": false,
      "description": "The deletion settings of the image, indicating whether to delete the underlying resources in addition to the image.",
      "properties": {
        "ExecutionRole": {
          "description": "The execution role to use for deleting the image, as well as underlying resources.",
          "type": "string"
        }
      },
      "required": ["ExecutionRole"],
      "type": "object"
    },
    "EcrConfiguration": {
      "additionalProperties": false,
      "description": "Settings for Image Builder to configure the ECR repository and output container images that are scanned.",
      "properties": {
        "ContainerTags": {
          "description": "Tags for Image Builder to apply the output container image that is scanned. Tags can help you identify and manage your scanned images.",
          "insertionOrder": true,
          "items": { "type": "string" },
          "type": "array"
        },
        "RepositoryName": {
          "description": "The name of the container repository that Amazon Inspector scans to identify findings for your container images. The name includes the path for the repository location. If you donâ€™t provide this information, Image Builder creates a repository in your account named image-builder-image-scanning-repository to use for vulnerability scans for your output container images.",
          "type": "string"
        }
      },
      "type": "object"
    },
    "ImageLoggingConfiguration": {
      "additionalProperties": false,
      "description": "The logging configuration settings for the image.",
      "properties": {
        "LogGroupName": {
          "description": "The name of the log group for image build logs.",
          "type": "string"
        }
      },
      "type": "object"
    },
    "ImagePipelineExecutionSettings": {
      "additionalProperties": false,
      "description": "The settings for starting an image pipeline execution.",
      "properties": {
        "DeploymentId": {
          "description": "The deployment ID of the pipeline, used to trigger new image pipeline executions.",
          "type": "string"
        },
        "OnUpdate": {
          "description": "Whether to trigger the image pipeline when the pipeline is updated. False by default.",
          "type": "boolean"
        }
      },
      "type": "object"
    },
    "ImageScanningConfiguration": {
      "additionalProperties": false,
      "description": "Contains settings for Image Builder image resource and container image scans.",
      "properties": {
        "EcrConfiguration": {
          "$ref": "#/definitions/EcrConfiguration",
          "description": "Contains ECR settings for vulnerability scans."
        },
        "ImageScanningEnabled": {
          "description": "This sets whether Image Builder keeps a snapshot of the vulnerability scans that Amazon Inspector runs against the build instance when you create a new image.",
          "type": "boolean"
        }
      },
      "type": "object"
    },
    "ImageTestsConfiguration": {
      "additionalProperties": false,
      "description": "The image tests configuration used when creating this image.",
      "properties": {
        "ImageTestsEnabled": {
          "description": "ImageTestsEnabled",
          "type": "boolean"
        },
        "TimeoutMinutes": {
          "description": "TimeoutMinutes",
          "maximum": 1440,
          "minimum": 60,
          "type": "integer"
        }
      },
      "type": "object"
    },
    "LatestVersion": {
      "additionalProperties": false,
      "description": "The latest version references of the image.",
      "properties": {
        "Arn": {
          "description": "The latest version ARN of the created image.",
          "type": "string"
        },
        "Major": {
          "description": "The latest version ARN of the created image, with the same major version.",
          "type": "string"
        },
        "Minor": {
          "description": "The latest version ARN of the created image, with the same minor version.",
          "type": "string"
        },
        "Patch": {
          "description": "The latest version ARN of the created image, with the same patch version.",
          "type": "string"
        }
      },
      "type": "object"
    },
    "WorkflowConfiguration": {
      "additionalProperties": false,
      "description": "The workflow configuration of the image",
      "properties": {
        "OnFailure": {
          "description": "Define execution decision in case of workflow failure",
          "enum": ["CONTINUE", "ABORT"],
          "type": "string"
        },
        "ParallelGroup": {
          "description": "The parallel group name",
          "type": "string"
        },
        "Parameters": {
          "description": "The parameters associated with the workflow",
          "insertionOrder": false,
          "items": { "$ref": "#/definitions/WorkflowParameter" },
          "type": "array"
        },
        "WorkflowArn": {
          "description": "The Amazon Resource Name (ARN) of the workflow",
          "type": "string"
        }
      },
      "type": "object"
    },
    "WorkflowParameter": {
      "additionalProperties": false,
      "description": "A parameter associated with the workflow",
      "properties": {
        "Name": { "type": "string" },
        "Value": {
          "insertionOrder": true,
          "items": { "$ref": "#/definitions/WorkflowParameterValue" },
          "type": "array"
        }
      },
      "type": "object"
    },
    "WorkflowParameterValue": {
      "description": "The value associated with the workflow parameter",
      "type": "string"
    }
  },
  "description": "Resource schema for AWS::ImageBuilder::Image",
  "handlers": {
    "create": {
      "permissions": [
        "ecr:BatchGetRepositoryScanningConfiguration",
        "iam:GetRole",
        "iam:PassRole",
        "iam:CreateServiceLinkedRole",
        "imagebuilder:GetImageRecipe",
        "imagebuilder:GetInfrastructureConfiguration",
        "imagebuilder:GetDistributionConfiguration",
        "imagebuilder:GetWorkflow",
        "imagebuilder:GetImage",
        "imagebuilder:CreateImage",
        "imagebuilder:TagResource",
        "inspector2:BatchGetAccountStatus"
      ],
      "timeoutInMinutes": 720
    },
    "delete": {
      "permissions": [
        "imagebuilder:GetImage",
        "imagebuilder:DeleteImage",
        "imagebuilder:UntagResource",
        "imagebuilder:CancelImageCreation"
      ]
    },
    "list": {
      "handlerSchema": {
        "properties": {
          "Arn": { "$ref": "resource-schema.json#/properties/Arn" }
        }
      },
      "permissions": [
        "imagebuilder:ListImages",
        "imagebuilder:ListImageBuildVersions"
      ]
    },
    "read": { "permissions": ["imagebuilder:GetImage"] },
    "update": {
      "permissions": ["imagebuilder:TagResource", "imagebuilder:UntagResource"]
    }
  },
  "oneOf": [
    { "required": ["ContainerRecipeArn", "InfrastructureConfigurationArn"] },
    { "required": ["ImageRecipeArn", "InfrastructureConfigurationArn"] },
    { "required": ["ImagePipelineExecutionSettings"] },
    { "required": ["ImportDiskImageSettings"] }
  ],
  "primaryIdentifier": ["/properties/Arn"],
  "properties": {
    "Arn": {
      "description": "The Amazon Resource Name (ARN) of the image.",
      "type": "string"
    },
    "ContainerRecipeArn": {
      "description": "The Amazon Resource Name (ARN) of the container recipe that defines how images are configured and tested.",
      "type": "string"
    },
    "DistributionConfigurationArn": {
      "description": "The Amazon Resource Name (ARN) of the distribution configuration.",
      "type": "string"
    },
    "EnhancedImageMetadataEnabled": {
      "description": "Collects additional information about the image being created, including the operating system (OS) version and package list.",
      "type": "boolean"
    },
    "ExecutionRole": {
      "description": "The execution role name/ARN for the image build, if provided",
      "type": "string"
    },
    "ImageId": {
      "description": "The AMI ID of the EC2 AMI in current region.",
      "type": "string"
    },
    "ImagePipelineExecutionSettings": {
      "$ref": "#/definitions/ImagePipelineExecutionSettings",
      "dependencies": {
        "ImagePipelineExecutionSettings": {
          "oneOf": [
            { "required": ["ImageRecipeArn"] },
            { "required": ["ContainerRecipeArn"] },
            { "required": ["InfrastructureConfigurationArn"] },
            { "required": ["Workflows"] },
            { "required": ["DistributionConfigurationArn"] },
            { "required": ["ImageTestsConfiguration"] },
            { "required": ["ImageScanningConfiguration"] },
            { "required": ["EnhancedImageMetadataEnabled"] },
            { "required": ["ImportDiskImageSettings"] }
          ]
        }
      },
      "description": "The image pipeline execution settings of the image."
    },
    "ImageRecipeArn": {
      "description": "The Amazon Resource Name (ARN) of the image recipe that defines how images are configured, tested, and assessed.",
      "type": "string"
    },
    "ImageScanningConfiguration": {
      "$ref": "#/definitions/ImageScanningConfiguration",
      "description": "Contains settings for vulnerability scans."
    },
    "ImageTestsConfiguration": {
      "$ref": "#/definitions/ImageTestsConfiguration",
      "description": "The image tests configuration used when creating this image."
    },
    "ImageUri": {
      "description": "URI for containers created in current Region with default ECR image tag",
      "type": "string"
    },
    "InfrastructureConfigurationArn": {
      "description": "The Amazon Resource Name (ARN) of the infrastructure configuration.",
      "type": "string"
    },
    "LatestVersion": {
      "$ref": "#/definitions/LatestVersion",
      "description": "The latest version references of the image."
    },
    "LoggingConfiguration": {
      "$ref": "#/definitions/ImageLoggingConfiguration",
      "description": "The logging configuration settings for the image."
    },
    "Name": { "description": "The name of the image.", "type": "string" },
    "Tags": {
      "additionalProperties": false,
      "description": "The tags associated with the image.",
      "patternProperties": { ".{1,}": { "type": "string" } },
      "type": "object"
    },
    "Workflows": {
      "description": "Workflows to define the image build process",
      "insertionOrder": true,
      "items": { "$ref": "#/definitions/WorkflowConfiguration" },
      "type": "array"
    }
  },
  "readOnlyProperties": [
    "/properties/Arn",
    "/properties/Name",
    "/properties/ImageId",
    "/properties/ImageUri",
    "/properties/LatestVersion",
    "/properties/LatestVersion/Arn",
    "/properties/LatestVersion/Major",
    "/properties/LatestVersion/Minor",
    "/properties/LatestVersion/Patch"
  ],
  "sourceUrl": "https://github.com/aws-cloudformation/aws-cloudformation-resource-providers-imagebuilder",
  "tagging": {
    "cloudFormationSystemTags": true,
    "permissions": ["imagebuilder:TagResource", "imagebuilder:UntagResource"],
    "tagOnCreate": true,
    "tagProperty": "/properties/Tags",
    "tagUpdatable": true,
    "taggable": true
  },
  "typeName": "AWS::ImageBuilder::Image",
  "writeOnlyProperties": ["/properties/ImagePipelineExecutionSettings"]
}
